{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
	"vnetName": {
	  "type": "String",
	  "defaultValue": "",
	  "metadata": {
		"description": "Name of the existing vnet to which Azure Bastion will be deployed."
	  }
	},
	"bastionSubnetIpPrefix": {
	  "type": "String",
	  "defaultValue": "",
	  "metadata": {
		"description": "The Bastion subnet IP prefix must be within vnet IP prefix address space."
	  }
	},
	"bastionHostName": {
	  "type": "String",
	  "metadata": {
		"description": "Name of Azure Bastion resource"
	  }
	},
	"location": {
	  "type": "String",
	  "defaultValue": "[resourceGroup().location]",
	  "metadata": {
		"description": "Azure region for Bastion and virtual network"
	  }
	}
  },
  "variables": {
	"bastion_PublicIpAddressName": "[format('{0}-pip', parameters('bastionHostName'))]",
	"bastion_SubnetName": "BastionSubnet",
	"bastion_NsgName": "[format('{0}-nsg', parameters('bastionHostName'))]",
	"bastion_DeployBool": "[bool(parameters('bastion_Deploy'))]"
  },
  "resources": [
	{
	  "type": "Microsoft.Network/publicIPAddresses",
	  "apiVersion": "2022-07-01",
	  "condition": "[variables('bastion_DeployBool')]",
	  "name": "[variables('bastion_PublicIpAddressName')]",
	  "location": "[parameters('location')]",
	  "sku": {
		"name": "Standard"
	  },
	  "properties": {
		"publicIPAllocationMethod": "Static"
	  }
	},
	{
	  "type": "Microsoft.Network/networkSecurityGroups",
	  "apiVersion": "2022-07-01",
	  "condition": "[variables('bastion_DeployBool')]",
	  "name": "[variables('bastion_NsgName')]",
	  "location": "[parameters('location')]",
	  "properties": {
		"securityRules": [
		  {
			"name": "AllowHttpsInBound",
			"properties": {
			  "protocol": "Tcp",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "Internet",
			  "destinationPortRange": "443",
			  "destinationAddressPrefix": "*",
			  "access": "Allow",
			  "priority": 100,
			  "direction": "Inbound"
			}
		  },
		  {
			"name": "AllowGatewayManagerInBound",
			"properties": {
			  "protocol": "Tcp",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "GatewayManager",
			  "destinationPortRange": "443",
			  "destinationAddressPrefix": "*",
			  "access": "Allow",
			  "priority": 110,
			  "direction": "Inbound"
			}
		  },
		  {
			"name": "AllowLoadBalancerInBound",
			"properties": {
			  "protocol": "Tcp",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "AzureLoadBalancer",
			  "destinationPortRange": "443",
			  "destinationAddressPrefix": "*",
			  "access": "Allow",
			  "priority": 120,
			  "direction": "Inbound"
			}
		  },
		  {
			"name": "AllowBastionHostCommunicationInBound",
			"properties": {
			  "protocol": "*",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "VirtualNetwork",
			  "destinationPortRanges": [
				"8080",
				"5701"
			  ],
			  "destinationAddressPrefix": "VirtualNetwork",
			  "access": "Allow",
			  "priority": 130,
			  "direction": "Inbound"
			}
		  },
		  {
			"name": "DenyAllInBound",
			"properties": {
			  "protocol": "*",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "*",
			  "destinationPortRange": "*",
			  "destinationAddressPrefix": "*",
			  "access": "Deny",
			  "priority": 1000,
			  "direction": "Inbound"
			}
		  },
		  {
			"name": "AllowSshRdpOutBound",
			"properties": {
			  "protocol": "Tcp",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "*",
			  "destinationPortRanges": [
				"22",
				"3389"
			  ],
			  "destinationAddressPrefix": "VirtualNetwork",
			  "access": "Allow",
			  "priority": 100,
			  "direction": "Outbound"
			}
		  },
		  {
			"name": "AllowAzureCloudCommunicationOutBound",
			"properties": {
			  "protocol": "Tcp",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "*",
			  "destinationPortRange": "443",
			  "destinationAddressPrefix": "AzureCloud",
			  "access": "Allow",
			  "priority": 110,
			  "direction": "Outbound"
			}
		  },
		  {
			"name": "AllowBastionHostCommunicationOutBound",
			"properties": {
			  "protocol": "*",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "VirtualNetwork",
			  "destinationPortRanges": [
				"8080",
				"5701"
			  ],
			  "destinationAddressPrefix": "VirtualNetwork",
			  "access": "Allow",
			  "priority": 120,
			  "direction": "Outbound"
			}
		  },
		  {
			"name": "AllowGetSessionInformationOutBound",
			"properties": {
			  "protocol": "*",
			  "sourcePortRange": "*",
			  "sourceAddressPrefix": "*",
			  "destinationAddressPrefix": "Internet",
			  "destinationPortRanges": [
				"80",
				"443"
			  ],
			  "access": "Allow",
			  "priority": 130,
			  "direction": "Outbound"
			}
		  },
		  {
			"name": "DenyAllOutBound",
			"properties": {
			  "protocol": "*",
			  "sourcePortRange": "*",
			  "destinationPortRange": "*",
			  "sourceAddressPrefix": "*",
			  "destinationAddressPrefix": "*",
			  "access": "Deny",
			  "priority": 1000,
			  "direction": "Outbound"
			}
		  }
		]
	  }
	},
	{
	  "type": "Microsoft.Network/virtualNetworks/subnets",
	  "apiVersion": "2022-07-01",
	  "condition": "[variables('bastion_DeployBool')]",
	  "name": "[format('{0}/{1}', parameters('vnetName'), variables('bastion_SubnetName'))]",
	  "properties": {
		"addressPrefix": "[parameters('bastionSubnetIpPrefix')]",
		"networkSecurityGroup": {
		  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('bastion_NsgName'))]"
		}
	  },
	  "dependsOn": [
		"[resourceId('Microsoft.Network/networkSecurityGroups', variables('bastion_NsgName'))]"
	  ]
	},
	{
	  "type": "Microsoft.Network/bastionHosts",
	  "apiVersion": "2022-07-01",
	  "condition": "[variables('bastion_DeployBool')]",
	  "name": "[parameters('bastionHostName')]",
	  "location": "[parameters('location')]",
	  "properties": {
		"ipConfigurations": [
		  {
			"name": "IpConf",
			"properties": {
			  "subnet": {
				"id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('bastion_SubnetName'))]"
			  },
			  "publicIPAddress": {
				"id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('bastion_PublicIpAddressName'))]"
			  }
			}
		  }
		]
	  },
	  "dependsOn": [
		"[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
		"[resourceId('Microsoft.Network/publicIPAddresses', variables('bastion_PublicIpAddressName'))]",
		"[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('bastion_SubnetName'))]"
	  ]
	}
  ]
}